# Malware Analysis

*All the good details about the bad details.*

1. [Hypervisor Escapes](#hypervisor-escapes)
2. [Analysis Host Considerations](#analysis-host-considerations)
3. [Analysis Virtual Environment Checklist](#analysis-virtual-environment-checklist)
4. [Analysis Virtual Network Checklist](#analysis-virtual-network-checklist)
5. [Reporting Template](#reporting-template)


## Hypervisor Escapes

Requirements:

- Specific hypervisor
- Specific hypervisor version
- Specific host
- Exploit chain

Echoing what's been said on the Husky Hacks Discord by Matt (paraphrasing):

> "The probability of encountering a hypervisor escape *for YOUR hypervisor* that's non-targeted is likened to that of a meteor strike."

*Summary: Most hypervisor escapes are targeted.*

- Keep your hypervisor up to date
- Keep your VM guest tools up to date
- Keep your host up to date
- Keep your firmware up to date


## Analysis Host Considerations

Options and ideas for monitoring and protecting the host.

- [ ] Rootkit detection
	* `rkhunter`
	* `chkrootkit`
	* `Autoruns`
- [ ] Logging / Monitoring
	* `auditd`
	* `Sysmon`
- [ ] IDS
	* `aide`
	* `tripwire`
	* `samhain`
	* `Wazuh`
- [ ] Network Monitoring
	* `Zeek`
	* `Suricata`
- [ ] Boot / OS protections
	* Secure Boot enabled
	* Kernel lockdown mode enabled
	* Update DBX
- [ ] Anti-malware
	* Windows Defender
- [ ] Endpoint agent / central log collection
	* Wazuh agent -> Wazuh server
	* Wazuh agent -> Security Onion
	* ssh cron task to collect logs from the analysis host

Be sure the host's firewall is configured appropriately.

Typically this means default deny inbound traffic, and disable any unnecessary services.

If inbound rules exist, ensure the service running is locked down. For example if SSH is running on the host, be sure it requires public key or MFA to log in.

Confirm the firewall rules with `nmap`.


## Analysis Virtual Environment Checklist

Steps to review for each stage in malware analysis.


#### Account creation, VM hardening:

- [ ] Use password:infected for WSL, Windows admin account
- [ ] Harden the browser if you intend to use it at all (outside of the lab, to acquire samples)
- [ ] Show hidden files / folders
- [ ] Show file extensions
- [ ] UTC Timezone

*Windows and WSL account passwords don't necessarily matter, you're executing the samples with admin privileges.*


#### Dealing with Defender:

- [ ] Create a dedicated folder for samples, exclude *ONLY* this folder from Defender.
	* Benefit of additional safety during static analysis
	* Simply disable Defender from the GUI for dynamic analysis


#### First Snapshot:

After all VM's are fully installed, updated, and equipped with necessary tools:

- [ ] Snapshot the 'latest update' state while it still has a network connection

*This makes rolling back for updates and acquiring samples easier.*


#### Acquiring samples and running updates:

- [ ] Ensure VM is rolled back to a known good 'ready' state
- [ ] Connect to a network to run updates / obtain samples
- [ ] Disconnect networking, and take a snapshot


#### Pre-detonation checklist:

*Copy any hashes or text out of the VM before turning off copy/paste for detonation*

The 'always do these' essentials:

- [ ] Ensure VM is connected to the correct virtual network

- [ ] Attempt to `ping` / `nmap` / `nc` the host from the VM
- [ ] Attempt to `ping` / `nmap` / `nc` the host's gateway from the VM
- [ ] Attempt to `ping -6` the link-local scope IPv6 address of your host
- [ ] Attempt to `ping 8.8.8.8` (or any public DNS) from the VM
- [ ] Attempt DNS resolution (`nslookup.exe google.com 9.9.9.9`) from the VM

- [ ] Disable Shared Folders
- [ ] Disable Copy and Paste (VMware: suspend guest, Settings > Options > Guest Isolation)
- [ ] Disable Drag and Drop (VMware: suspend guest, Settings > Options > Guest Isolation)

- [ ] Take a snapshot

In higher risk scenarios, do one or all of the following:

- [ ] Remove CD/DVD virtual device
- [ ] Remove USB virtual device
- [ ] Remove Sound Card virtual device
- [ ] Remove Network virtual device
- [ ] Turn off 3D or hardware-based acceleration
- [ ] Uninstall VM Tools (VMware Tools / open-vm-tools-desktop / VirtualBox Guest Addtions)

Additional considerations:

<https://www.virtualbox.org/manual/UserManual.html#security-recommendations>

- [ ] VMware: Settings > Hardware > Processors > ✅ Virtualize Intel VT-x/EPT of AMD-V/RVI
- [ ] VirtualBox: System Settings > Acceleration > ❌ Enable Nested Paging


#### Post-detonation checklist:

- [ ] Screenshot / record relevant data
- [ ] Note any relevant data
- [ ] Restore last good snapshot
- [ ] Repeat virtual network leak tests after restore

Additional considerations:

- [ ] Suspend / pause guest VM's when copy / pasting large notes around on your host (clipboard injection)

Obtaining data from an infected guest after removing all guest VM tools and functionality:

- Copy text manually
- Screenshots + OCR
- Using a separate, hardened guest on the same virtual subnet that is a different OS than the infected guest.
	* This guest can have VM tools installed, with ONLY copy + paste (no shared folders, drag + drop, external networking, etc)
	* SSH into the infected guest
	* Serve text, files, or data from a `python3 -m http.server 8080 --bind <guest-ip-or-localhost>`
		- On Windows guests using WSL, that were setup manually without FLARE-VM, you need a set of portproxy rules to access the webserver
		- `netsh interface portproxy add v4tov4 listenport=8080 listenaddress=<public-up> connectport=8080 connectaddress=<wsl-virtual-ip>`
		- `netsh interface portproxy add v4tov4 listenport=8080 listenaddress=<wsl-virtual-ip> connectport=8080 connectaddress=127.0.0.1`


## Analysis Virtual Network Checklist

*Dedicate an "internal" (purely virtual) network for analysis*

The tldr; version is use one of these two, they take moments to setup:

- [VMware, "Lan Segments"](https://docs.vmware.com/en/VMware-Workstation-Pro/16.0/com.vmware.ws.using.doc/GUID-CC791418-B30C-487D-8F57-E7E855B61549.html)
- [VirtualBox, "Internal Networking"](https://www.virtualbox.org/manual/UserManual.html#network_internal)

You'll want to review the documents for VMware and VirtualBox on how they describe virtual networks:

> A LAN segment is a private network that is shared by other virtual machines. A LAN segment can
> be useful for multitier testing, network performance analysis, and situations where virtual
> machine isolation are important.

---

`Host-Only` for VMware Workstation has a comparable option allowing you to disconnect the host, but LAN segments achieve this in a better way, and without creating any virtual device under `/dev/` on a (Linux) host.

- [Vmware Workstation Pro 16 Guide](https://docs.vmware.com/en/VMware-Workstation-Pro/16.0/workstation-pro-16-user-guide.pdf)
	* "Configuring Host-Only Networking" p243
	* "Disconnect a Host Virtual Network Adapter", p227
	* "Configure LAN Segments", p256

These are the two main setup guides for isolated virtual networks:

- [HuskyHacks - Virtual Network Isolation](https://notes.huskyhacks.dev/blog/malware-analysis-labs-internal-network-vs-host-only)

- [Zeltser - Virtual Network Isolation](https://zeltser.com/vmware-network-isolation-for-malware-analysis/)


#### DHCP

The issue with DHCP, whether it's VMware's built in server, or from behind a hardened pfSense VM subnet, is that *a DHCP service is reachable*.

If you want fully isolated internal networking, create a virtual network *without* a pfSense VM or VMware acting as the DHCP server and gateway, and do static IP assignments to the guests. This pairs great with something like `inetsim` running on one of the guests within the subnet. A pfSense VM alone is entirely fine so long as it's not connected to the public internet through another network interface / adapter.


### VirtualBox - Dedicated Virtual Network

HuskyHacks resources:

- <https://notes.huskyhacks.dev/blog/malware-analysis-labs-internal-network-vs-host-only>

Create the virtual (internal) network:

- [ ] Create a new internal network by name (ie, analysis-network)
- [ ] Advanced > Promiscuous Mode: > Allow VMs


### VMware - Dedicated Virtual Network

#### Option 1 | LAN Segment

This is very similar to HuskyHacks' guide using VirtualBox's Internal Networking, and is the recommended way to provision an isolated network.

LAN Segments are purely virtual networks only for VM's. Their configuration depends entirely on the network settings of the VM's within them. Without having another network adapter attached or some kind of network Bridge, they cannot communicate with the host or the outside world.

- [ ] Create a new LAN Segment under `VM > Settings > Network Adapter > LAN Segment`, naming it whatever makes sense.

That's it! You can jump ahead to [static network assignments](#static-network-assignments).

Lenny Zeltser's resources for Option 2:

- <https://zeltser.com/vmware-malware-analysis/>
- <https://zeltser.com/vmware-network-isolation-for-malware-analysis/>
- <https://zeltser.com/build-malware-analysis-toolkit/>


#### Option 2 | Host-Only Without the Host

- [ ] "Add Network..." in the virtual network editor to create a subnet for malware analysis
- [ ] Choose an arbitrary number for vmnetX like 50, vmnet0, vmnet1, and vmnet8 are commonly used defaults so anything over 10 will be fine
- [ ] Set this network to "Host-only"
- [ ] Uncheck "Connect a host virtual adapter (vmnetX) to this network, we don't want the host on this network
	* This will show "Host Connection" as "none" in the table at the top
	* Devices that have this checked will be visible as other network adapters on your Linux host
	* Devices without this (like the auto-bridged vmnet0) are not logically connected to your host (but bridges share the host network card)
	* Confirm this by using the built in Host-Only adapter which is visible from the host. You can reach the host from this adapter.
- [ ] Uncheck "Use local DHCP service to distribute IP addresses to VMs
- [ ] Assign a subnet range and subnet mask
- [ ] Save
- [ ] Reboot (required on a Linux host for the virtual device to be available to the VM's)
- [ ] Assign this to your VM as a "Custom: Specific virtual network"
	* vmnet50 for example

Confirm your host does not have `vmnet50` (or whatever number you gave it) as a network adapter / device:

```bash
ifconfig
# or
ip a
```

### Static Network Assignments

We'll use `10.99.99.0/24` as the subnet, and assign `10.99.99.3` to Kali, while Windows 11 gets `10.99.99.4`.

Assign network information to Linux guests (running inetsim):

- [ ] `sudo nano /etc/netplan/01-netcfg.yml`
- [ ] dhcp4: no
- [ ] addresses: [10.90.90.3/24]
- [ ] gateway4: 10.90.90.1
- [ ] `sudo netplan apply`

*For Kali running xfce, search "network" from the menu and choose "Advanced Network Configuration" to do this. Kali does not use netplan.*

If the configuration changes made via the `Advanced Network Configuration` GUI aren't persisting, you can do all of it manually with `ip`:

```bash
# if eth0 is partially configured, flush it's configuration to avoid issues:
sudo ip address flush dev eth0 scope global

# create a new interface, type is bridge:
sudo ip address add dev eth0 10.99.99.3/24 broadcast 10.99.99.255 scope global noprefixroute
sudo ip route add default via 10.99.99.1 dev eth0
```

Assign network information to the Windows guest (these steps are for Windows 11):

- [ ] Network & Internet > Advanced network settings > [adapter-name] > View additional properties > IP assignment > Edit
- [ ] IPv4 address: 10.90.90.4/24
- [ ] Subnet mask: 255.255.255.0
- [ ] Default gateway: 10.90.90.3 (Linux guest running inetsim)
- [ ] IPv4 DNS servers: 10.90.90.3 (Linux guest running inetsim)


### INetSim

Apply these changes to `/etc/inetsim/inetsim.conf`:

- `start_service dns`
- `service_bind_address 0.0.0.0`
- `dns_default_ip <remnux-ip-addr>`
- `service_run_as_user inetsim` (running as nobody cannot write to the logfile)
- `dns_default_hostname <hostname>`
- `dns_default_domainname <domain>`

For *hostname*, you could use `dns`, then for *domainname*, use `<example>.net` to simulate a real URI.

All services will run by default which my be what you require. Otherwise, you can limit the services running to just these, comment out the rest:

- `start_service dns`
- `start_service http`
- `start_service https`


### Confirm Settings

Confirm this is working, try downloading a binary and execute it to see the inetsim GUI library message:

```powershell
curl http://microsoft.com/super-secure.exe -OutFile super-secure.exe
.\super-secure.exe
```

Try looking up a DNS name:

```powershell
PS C:\Users\User> nslookup.exe microsoft.com                                                                                                                       Server:  www.inetsim.org
Address:  10.90.90.3

Name:    microsoft.com
Address:  10.90.90.3
```

You won't be able to reach the non existent gateway on this virtual network:

```bash
└─$ ping 10.90.90.1
PING 10.90.90.1 (10.90.90.1) 56(84) bytes of data.
From 10.90.90.3 icmp_seq=1 Destination Host Unreachable
From 10.90.90.3 icmp_seq=2 Destination Host Unreachable
From 10.90.90.3 icmp_seq=3 Destination Host Unreachable
From 10.90.90.3 icmp_seq=4 Destination Host Unreachable
From 10.90.90.3 icmp_seq=5 Destination Host Unreachable
From 10.90.90.3 icmp_seq=6 Destination Host Unreachable
```

It's also worth checking IPv6 with your host's link-local scope address (fe80::...) as IPv6 can *always* talk to 'neighboring' devices.

```powershell
PS C:\> ping -6 ping -6 fe80::abcd:ef12:3456:789

Pinging fe80::abcd:ef12:3456:789 with 32 bytes of data:
Destination host unreachable.
Destination host unreachable.
Destination host unreachable.
Destination host unreachable.

Ping statistics for fe80::abcd:ef12:3456:789:
    Packets: Sent = 4, Received = 0, Lost = 4 (100% loss),
PS C:\Users\User\Documents>
```

You *will* be able to reach all other VM's on the same LAN Segment with `ping -6` because of how link-local scope works on IPv6. That's why it's a great indicator of network isolation.

Turn off `inetsim`, and confirm your network is configured correctly:

Linux VM's:

| Command                | Expected Result            |
| ---------------------- | -------------------------- |
| `ip a` or `ifconfig`   | Show internal network only |
| `ping google.com`      | FAIL                       |
| `ping 9.9.9.9`         | FAIL                       |
| `ping 8.8.8.8`         | FAIL                       |
| `ping 1.1.1.1`         | FAIL                       |
| `ping <physical-host>` | FAIL                       |
| `ping <neighbor-vm>`   | OK                         |

Windows VM's:

| Command               | Expected Result            |
| --------------------- | -------------------------- |
| `ipconfig`            | Show internal network only |
| `ping google.com`     | FAIL                       |
| `ping 9.9.9.9`        | FAIL                       |
| `ping 8.8.8.8`        | FAIL                       |
| `ping 1.1.1.1`        | FAIL                       |
| `ping <phyiscal-host` | FAIL                       |
| `ping <neighbor-vm>`  | OK                         |

You're ready to go!


### Best Practices from the Zelster Blog:

<https://zeltser.com/vmware-malware-analysis/>

> There have been several publicly announced vulnerabilities in VMware that, in theory, could allow malicious code from the virtual system to [find its way onto the physical host](http://taviso.decsystem.org/virtsec.pdf).

> - Keep up with security patches from VMware.
> - Dedicate the physical host to the VMware-based lab; don't use the system for other purposes.
> - Do not connect the physical laboratory system to your production network.
> - Monitor the physical host with host-based intrusion detection (IDS) software, such as a file-integrity checker.
> - Periodically re-image the physical host using cloning software, such as Norton Ghost. If this option is too slow, look to hardware modules, such as CoreRESTORE, for undoing changes to the system's state.

**NOTE**: `dd` could be used to quickly and easily image a backup of a Linux host. No cloning software required.


## Reporting Template

- Executive Summary

- Effective Risk

- Scope of Infection

- Mitigation and Remediation

- Technical Summary

Basic Static Analysis

- [ ] Hashes & VT / Sandbox Analysis
- [ ] Binary data / Composition
- [ ] PE data
- [ ] Sections / Entropy
- [ ] ssdeep
- [ ] IAT
- [ ] Libraries
- [ ] API Calls
- [ ] Exports
- [ ] Strings
- [ ] Resources
- [ ] ASLR? Set to false, save a copy

Advanced Static Analysis

[OA Labs | Malware Triage Tips: How To Stop Wasting Time in IDA On Packed Samples](https://www.youtube.com/watch?v=f59HWEFG5Do)

If you see any of the following, go directly to a sandbox or dynamic analysis and don't waste time:

- Heavy obfuscation
- Packing
- IDA cannot load the graph view
- Junk function calls with junk arguments
- Routines not checking the return value `eax` / `rax` of function calls
- API being called repeatedly for no reason (API hammering)

Otherwise:

- [ ] IDA / Cutter
	* Interesting subroutines
		- Rename routines
	* Execution flow
		- Make notes in pseudocode for an overview of behavior
	* Obfuscation?
		- Stack strings?
		- xor instructions not zeroing a register and in a loop?
	* Patch necessary?
		- Patch instructions to defang malicious subroutines and functions
		- Save a copy of the patched binary to run / debug

Basic Dynamic Analysis

- [ ] Network-based
	* Remote hosts
	* DNS
	* Ports + protocols
- [ ] Host-based
	* Files
	* Paths
	* Commands
	* Registry
	* Sockets
	* WMI
	* Scheduled tasks
	* Modifications
	* Visual indicators

Advanced Dynamic Analysis

- [ ] Search all modules for string references
- [ ] Breakpoints on key functions
	* `bp VirtualAlloc`
		- Execute until return then follow EAX / RAX address in dump
	* URLDownloadToFile
	* ShellExecute
	* CreateRemoteThread
	* Process32First / Process32Next
	* And many others not mentioned here
- [ ] Extract data from memory
	* Carve files from memory dumps
	* Repair damaged data (Scylla)
- [ ] Break on decryption / deobfuscation routines to look for keys

- Hunting Queries

- Log Entries / Artifacts

- Appendices / Links

